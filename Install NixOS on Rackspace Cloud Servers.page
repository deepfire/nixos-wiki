Install NixOS on Rackspace Cloud Servers
========================================

This are just a few notes I took down while performing a NixOS
installation on a freshly created Rackspace Cloud Server running Gentoo.

Disclaimer
----------

Prerequisites
-------------

We are going need the contents of the following files, so it might be a
good idea to write them down or download those files to your local
machine.

    # cat /etc/resolve.conf | tail -n 2
    nameserver 72.3.128.240
    nameserver 72.3.128.241

    # cat /etc/conf.d/net | tail -n 9
    modules="ifconfig"

    config_eth0="209.61.142.12 netmask 255.255.255.0"
    routes_eth0="default via 209.61.142.1"
    dns_servers_eth0="72.3.128.240
    72.3.128.241"
    config_eth1="10.180.133.23 netmask 255.255.128.0"
    routes_eth1="10.176.0.0/12 via 10.180.128.1
    10.191.192.0/18 via 10.180.128.1"

    # cat /etc/fstab | tail -n 4
    /dev/xvda1  /            ext3     defaults,noatime,barrier=0    1 2
    /dev/xvdc1  swap         swap     defaults                      0 0
    proc        /proc        proc     defaults                      0 0
    shm         /dev/shm     tmpfs    nodev,nosuid,noexec           0 0

Installation
------------

Put your Cloud Server into Rescue Mode from the Rackspace Cloud control
panel.

First thing we want to do is formatting our root partition and mount it
to /mnt.

    # mkfs.ext3 /dev/xvdb1
    # mount /dev/xvdb1 /mnt

Next we need to download the minimal installation CD and mount it some
place.

    # cd ~
    # mkdir inst host
    # wget http://nixos.org/releases/nixos/latest-iso-minimal-x86_64-linux
    # modprobe loop
    # mount -o loop latest-iso-minimal-x86_64-linux ./inst
    # unsquashfs inst/nix-store.squashfs '*' -d host/nix/store

We also need the unsquashfs binary from squashfs-tools. You can install
it by the following commands.

    # emerge --sync
    # emerge squashfs-tools

Next, we extract nix-store.squashfs from the installation medium to
yield a NixOS system we can chroot into.

    # cp /etc/resolve.conf host/nix/etc/
    # mkdir host/dev host/proc host/sys
    # for fn in dev proc sys; do mount --bind /$fn host/fn; done

    # find host -type f -name init | grep nixos
    host/nix/store/abwlkvzyjd2i39b1l1wfv7v9ilx88fwi-nixos-0.1pre34067-34077/init
    # find host -type f -name bash | tail -n 1
    host/nix/store/bmgq2jrn6719r6j55gs4rzfp0azcbazy-bash-4.2-p24/bin/bash

(edit init, add bash call, remove upstart)

    # chroot host /nix/store/abwlkvzyjd2i39b1l1wfv7v9ilx88fwi-nixos-0.1pre34067-34077/init

    # (chroot) nixos-option --install
    # (chroot) $EDITOR /etc/nixos/configuration.nix

(example configuration file)

    # (chroot) nixos-checkout
    # (chroot) nixos-install

(set root password)

